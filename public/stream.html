<!DOCTYPE html>
<html>
<head>
  <title>Remote Control</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
    }
    #statusPanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #222;
      border: 1px solid #555;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    #statusPanel ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #statusPanel li {
      margin: 4px 0;
    }
    h1 {
      margin: 10px 0;
      text-align: center;
    }
    img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100vh;
    }
  </style>
</head>
<body>
  <h1>Competent Technologies (MilkJet)</h1>
  <img id="screen" src="" />

  <div id="statusPanel">
    <strong>Device Status</strong>
    <ul id="devicesList"></ul>
  </div>

  <script>
    const socket = io("https://checkserver-rmqt.onrender.com");

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id") || "default";

    const img = document.getElementById("screen");
    img.src = `http://checkserver-rmqt.onrender.com/stream/${id}`;

    const deviceIdTouch = `${id}_touch`;
    const deviceIdKeyboard = `${id}_keyboard`;

    const devicesList = document.getElementById("devicesList");

    // create two entries
    const touchItem = document.createElement("li");
    touchItem.textContent = `${deviceIdTouch}: ðŸ”´ Inactive`;
    devicesList.appendChild(touchItem);

    const keyboardItem = document.createElement("li");
    keyboardItem.textContent = `${deviceIdKeyboard}: ðŸ”´ Inactive`;
    devicesList.appendChild(keyboardItem);

    // store the status for later updates
    const deviceStatus = {
      [deviceIdTouch]: false,
      [deviceIdKeyboard]: false
    };

    socket.emit("register_device", { id: "browser" });

    // handle registering devices
    socket.on("connect", () => {
      console.log("âœ… Connected to Socket.IO server");
    });

    socket.on("register_device", data => {
      console.log("registered device", data);
    });

    // on reconnect, request status again
    socket.on("connect", () => {
      socket.emit("register_device", { id: "browser" });
    });

    // show active devices by watching console events
    socket.onAny((event, data) => {
      if (event === "touch" || event === "key") {
        console.log(`${event} event`, data);
        // optionally you could handle activity here
      }
    });

    // monitor connected/disconnected devices
    socket.on("device_status", (list) => {
      console.log("device status update", list);

      // reset status
      deviceStatus[deviceIdTouch] = false;
      deviceStatus[deviceIdKeyboard] = false;

      for (const idKey of list) {
        if (idKey === deviceIdTouch) deviceStatus[deviceIdTouch] = true;
        if (idKey === deviceIdKeyboard) deviceStatus[deviceIdKeyboard] = true;
      }

      touchItem.textContent = `${deviceIdTouch}: ${deviceStatus[deviceIdTouch] ? "ðŸŸ¢ Active" : "ðŸ”´ Inactive"}`;
      keyboardItem.textContent = `${deviceIdKeyboard}: ${deviceStatus[deviceIdKeyboard] ? "ðŸŸ¢ Active" : "ðŸ”´ Inactive"}`;
    });

    // let the server know to send us device lists
    setInterval(() => {
      socket.emit("request_device_status");
    }, 2000);

    // handle clicks
    const xOffset = -20;
    const yOffset = 28;
    img.addEventListener("click", e => {
      const correctedX = e.offsetX + xOffset;
      const correctedY = e.offsetY + yOffset;
      console.log(`sending touch to device ${deviceIdTouch} at ${correctedX},${correctedY}`);
      socket.emit("touch", {
        deviceId: deviceIdTouch,
        type: "tap",
        x: correctedX,
        y: correctedY
      });
    });

    document.addEventListener("keydown", e => {
      console.log(`sending key to device ${deviceIdKeyboard}: ${e.key}`);
      socket.emit("key", {
        deviceId: deviceIdKeyboard,
        key: e.key,
        code: e.code,
        keyCode: e.keyCode
      });
    });

  </script>
</body>
</html>
