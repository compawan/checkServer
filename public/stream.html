<!DOCTYPE html>
<html>
<head>
  <title>Remote Control</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: black;
      color: white;
      font-family: sans-serif;
    }
    h1 {
      margin: 10px 0;
      text-align: center;
    }
    img {
      display: block;
      margin: 0 auto;
      max-width: 90%;
      max-height: 80%;
    }
    #status-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(255,255,255,0.1);
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: left;
      font-size: 14px;
      max-height: 90%;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Competent Technologies (MilkJet)</h1>

  <div id="status-panel">
    <div><strong>Device:</strong> <span id="deviceStatus">ðŸ”´ Disconnected</span></div>
    <div><strong>Touch:</strong> <span id="touchStatus">ðŸ”´ Inactive</span></div>
    <div><strong>Keyboard:</strong> <span id="keyboardStatus">ðŸ”´ Inactive</span></div>
    <hr>
    <div><strong>Registered devices:</strong></div>
    <ul id="devicesList"></ul>
  </div>

  <img id="screen" src="" />

  <script>
    const socket = io("https://checkserver-rmqt.onrender.com");

    socket.emit("register_device", { id: "browser" });

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id") || "default";

    const img = document.getElementById("screen");
    img.src = `http://checkserver-rmqt.onrender.com/stream/${id}`;

    const deviceIdTouch = `${id}_touch`;
    const deviceIdKeyboard = `${id}_keyboard`;

    const deviceStatus = document.getElementById("deviceStatus");
    const touchStatus = document.getElementById("touchStatus");
    const keyboardStatus = document.getElementById("keyboardStatus");
    const devicesList = document.getElementById("devicesList");

    socket.on("connect", () => {
      console.log("âœ… Connected to server");
      deviceStatus.textContent = "ðŸŸ¢ Connected";
    });

    socket.on("disconnect", () => {
      console.log("âŒ Disconnected from server");
      deviceStatus.textContent = "ðŸ”´ Disconnected";
      touchStatus.textContent = "ðŸ”´ Inactive";
      keyboardStatus.textContent = "ðŸ”´ Inactive";
      devicesList.innerHTML = "";
    });

    // devices list update from server
    socket.on("devices_update", deviceArray => {
      devicesList.innerHTML = "";
      deviceArray.forEach(dev => {
        const li = document.createElement("li");
        li.textContent = dev;
        devicesList.appendChild(li);
      });
    });

    const xOffset = -20;
    const yOffset = 28;

    img.addEventListener("click", e => {
      const correctedX = e.offsetX + xOffset;
      const correctedY = e.offsetY + yOffset;

      console.log(`sending touch to device ${deviceIdTouch} at ${correctedX},${correctedY}`);

      socket.emit("touch", {
        deviceId: deviceIdTouch,
        type: "tap",
        x: correctedX,
        y: correctedY
      });

      touchStatus.textContent = "ðŸŸ¢ Active";
    });

    document.addEventListener("keydown", e => {
      console.log(`sending key to device ${deviceIdKeyboard}: ${e.key}`);
      socket.emit("key", {
        deviceId: deviceIdKeyboard,
        key: e.key,
        code: e.code,
        keyCode: e.keyCode
      });

      keyboardStatus.textContent = "ðŸŸ¢ Active";
    });
  </script>
</body>
</html>
