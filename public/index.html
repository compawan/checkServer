<!DOCTYPE html>
<html>
<head>
  <title>Remote Control</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { margin: 0; }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      background: black; /* shows black initially instead of last stale frame */
    }
  </style>
</head>
<body>
  <canvas id="screen"></canvas>
  <script>
    const canvas = document.getElementById("screen");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const deviceIdTouch = "7052_touch";
    const deviceIdKeyboard = "7052_keyboard";

    const socket = io("https://checkserver-rmqt.onrender.com");

    socket.emit("register_device", { id: "browser" });

    // MJPEG stream handling
    const mjpegStream = new Image();
    mjpegStream.src = "http://checkserver-rmqt.onrender.com/stream/7052";

    mjpegStream.onload = function draw() {
      ctx.drawImage(mjpegStream, 0, 0, canvas.width, canvas.height);
      requestAnimationFrame(draw);
    };

    // clicks
    const xOffset = -20;
    const yOffset = 28;

    canvas.addEventListener("click", e => {
      const correctedX = e.offsetX + xOffset;
      const correctedY = e.offsetY + yOffset;

      console.log(`sending touch to device ${deviceIdTouch} at ${correctedX},${correctedY}`);

      socket.emit("touch", {
        deviceId: deviceIdTouch,
        type: "tap",
        x: correctedX,
        y: correctedY
      });
    });

    // keys
    document.addEventListener("keydown", e => {
      console.log(`sending key to device ${deviceIdKeyboard}: ${e.key}`);
      socket.emit("key", {
        deviceId: deviceIdKeyboard,
        key: e.key,
        code: e.code,
        keyCode: e.keyCode
      });
    });
  </script>
</body>
</html>
